<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ø¹Ú©Ø³ Ø§ÛŒØªØ§</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://bot.eitaa.com/eitaa-web-app.js"></script>
    <style>
        body { 
            margin: 0; padding: 15px; font-family: Tahoma, sans-serif; 
            background-color: #f4f4f4; color: #333; text-align: right; direction: rtl;
        }
        .container { max-width: 450px; margin: 0 auto; }
        input[type="file"], textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        button { width: 100%; background-color: #5ac663; color: white; border: none; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .status-box { padding: 10px; margin-bottom: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #credit-menu button { margin-top: 5px; width: 48%; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¹Ú©Ø³</h2>
        <div id="app-status" class="status-box">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¹Ø¶ÙˆÛŒØª Ø´Ù…Ø§...</div>
        <div id="main-form" style="display:none;">
            <p id="credit-display">Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: **0**</p>
            <label>1. Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³:</label>
            <input type="file" id="image-file" accept="image/jpeg,image/png" required>
            <label>2. Ù¾Ø±Ø§Ù…Ù¾Øª:</label>
            <textarea id="prompt-text" placeholder="Ù…Ø«Ø§Ù„: Ø§ÛŒÙ† Ø´Ø®Øµ Ø±Ø§ Ø¨Ø§ Ø¹ÛŒÙ†Ú© Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡." required></textarea>
            <button onclick="processImage()" id="process-btn">ğŸ”„ Ø´Ø±ÙˆØ¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ú©Ø³</button>
        </div>
        <div id="credit-menu" style="display:none; text-align:center;">
            <p class="error">Ø§Ø¹ØªØ¨Ø§Ø± Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
            <button onclick="buyCredit(10)">+10 Ø¹Ú©Ø³</button>
            <button onclick="buyCredit(20)">+20 Ø¹Ú©Ø³</button>
        </div>
        <div id="output-area" style="margin-top:20px; display:none;">
            <h4>âœ… Ù†ØªÛŒØ¬Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´:</h4>
            <pre id="output-text" class="status-box success"></pre>
        </div>
        <button onclick="Eitaa.WebApp.close()" style="background-color:#f1f1f1;color:#333;">âŒ Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ú©</button>
    </div>

<script>
let userId;

if(window.Eitaa && Eitaa.WebApp.initDataUnsafe && Eitaa.WebApp.initDataUnsafe.user){
    Eitaa.WebApp.ready();
    userId = Eitaa.WebApp.initDataUnsafe.user.id;
    checkStatus();
}else{
    const statusDiv = document.getElementById('app-status');
    statusDiv.className='status-box error';
    statusDiv.innerText='âŒ Ø®Ø·Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø±Ø¨Ø§Øª Ø§ÛŒØªØ§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.';
}

async function checkStatus(){
    try{
        const res = await fetch('/api/status',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId})
        });
        const data = await res.json();
        const statusDiv = document.getElementById('app-status');
        const creditDisplay = document.getElementById('credit-display');

        if(data.is_member){
            statusDiv.className='status-box success';
            statusDiv.innerText='âœ… Ø¹Ø¶ÙˆÛŒØª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.';
            creditDisplay.innerText=`Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: **${data.credits}** Ø¹Ú©Ø³`;
            if(data.credits>0){
                document.getElementById('main-form').style.display='block';
                document.getElementById('credit-menu').style.display='none';
            }else{
                document.getElementById('main-form').style.display='none';
                document.getElementById('credit-menu').style.display='block';
            }
        }else{
            statusDiv.className='status-box error';
            statusDiv.innerHTML=`âŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ú©ØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø´ÙˆÛŒØ¯:<br>${data.required_channels.map(c=>`<a href="https://t.me/${c}" target="_blank">@${c}</a>`).join(', ')}`;
            document.getElementById('main-form').style.display='none';
            document.getElementById('credit-menu').style.display='none';
        }
    }catch{
        const statusDiv = document.getElementById('app-status');
        statusDiv.className='status-box error';
        statusDiv.innerText='âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.';
    }
}

async function processImage(){
    const fileInput=document.getElementById('image-file');
    const promptText=document.getElementById('prompt-text').value;
    const processBtn=document.getElementById('process-btn');

    if(!fileInput.files.length||!promptText){
        alert('Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ Ùˆ Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        return;
    }

    processBtn.disabled=true;
    processBtn.innerText='... Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙˆØ³Ø· Gemini';
    document.getElementById('output-area').style.display='none';

    const reader=new FileReader();
    reader.onloadend=async function(){
        const base64Image=reader.result;
        try{
            const res=await fetch('/api/process_image',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_id:userId,image:base64Image,prompt:promptText})
            });
            const data=await res.json();
            if(data.status==='success'){
                document.getElementById('output-text').innerText=data.result;
                document.getElementById('output-area').style.display='block';
                document.getElementById('credit-display').innerText=`Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: **${data.remaining_credits}** Ø¹Ú©Ø³`;
                Eitaa.WebApp.sendData(JSON.stringify({result:'success',prompt:promptText}));
            }else{
                alert(`Ø®Ø·Ø§: ${data.message||'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`);
            }
        }catch{
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±.');
        }finally{
            processBtn.disabled=false;
            processBtn.innerText='ğŸ”„ Ø´Ø±ÙˆØ¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ú©Ø³';
            checkStatus();
        }
    }
    reader.readAsDataURL(fileInput.files[0]);
}

async function buyCredit(amount){
    const creditMenu=document.getElementById('credit-menu');
    creditMenu.innerHTML='Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙØ­Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª...';
    try{
        const res=await fetch('/api/buy_credit',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId,amount:amount})
        });
        const data=await res.json();
        alert(`ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ ${amount} Ø§Ø¹ØªØ¨Ø§Ø± Ø®Ø±ÛŒØ¯ÛŒØ¯. Ø§Ø¹ØªØ¨Ø§Ø± Ø¬Ø¯ÛŒØ¯: ${data.new_credits}`);
        checkStatus();
    }catch{
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±.');
        checkStatus();
    }
}
</script>
</body>
</html>
