<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¹Ú©Ø³</title>
  <style>
    body { font-family: Tahoma, sans-serif; text-align: center; margin-top: 30px; }
    .box { display:inline-block; padding:16px; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    input[type="file"] { margin:10px 0; }
    button { padding:10px 16px; cursor:pointer; }
    img { max-width:300px; display:block; margin:12px auto; border-radius:8px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¹Ú©Ø³ ðŸ“¸</h2>
    <p id="status">Ø§Ø¨ØªØ¯Ø§ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>
    <p><a id="channel-link" href="{{ channel }}" target="_blank">{{ channel }}</a></p>

    <form id="upload-form">
      <input type="file" id="image" name="image" accept="image/*" required><br>
      <input type="text" id="prompt" name="prompt" placeholder="ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡ Ú†Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ..." style="width: 300px;"><br>
      <input type="hidden" name="user_id" id="user_id" value="test_user">
      <button type="submit">Ø§Ø±Ø³Ø§Ù„ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´</button>
    </form>

    <div id="result" style="display:none;">
      <h4>Ù†ØªÛŒØ¬Ù‡:</h4>
      <img id="out-img" src="" alt="Ø®Ø±ÙˆØ¬ÛŒ">
      <p id="credits"></p>
    </div>
  </div>

  <script>
    async function checkMembership() {
      const res = await fetch("/check_membership");
      const j = await res.json();
      if (j.success && j.is_member) {
        document.getElementById("status").textContent = "Ø¹Ø¶ÙˆÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ â€” Ø§Ø¹ØªØ¨Ø§Ø±: " + j.credits;
        document.getElementById("credits").textContent = "Ø§Ø¹ØªØ¨Ø§Ø±: " + j.credits;
      } else {
        document.getElementById("status").textContent = "Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.";
      }
    }
    window.onload = checkMembership;

    const form = document.getElementById("upload-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fdata = new FormData(form);
      document.getElementById("status").textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
      const res = await fetch("/upload", { method: "POST", body: fdata });
      const j = await res.json();
      if (!j.success) {
        document.getElementById("status").textContent = "Ø®Ø·Ø§: " + (j.error || "Ù†Ø§Ù…Ø´Ø®Øµ");
        return;
      }
      document.getElementById("out-img").src = j.output_url + "?t=" + Date.now();
      document.getElementById("result").style.display = "block";
      document.getElementById("credits").textContent = "Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: " + j.remaining_credits;
      document.getElementById("status").textContent = "Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…";
    });
  </script>
</body>
</html>
